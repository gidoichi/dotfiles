#!/bin/sh
# -*- mode:shell-script -*-


######################################################################
# Initial Configuration
######################################################################

set -eu

print_usage_and_exit () {
    cat <<-USAGE 1>&2
	標準入力からデータ受け取りファイルとして \$EDITOR で開く

	Usage   : ${0##*/} [options]
	Options : -e <extension> ... シンタックスハイライト用拡張子
	          -f <filename> .... エディタで指定したいファイル名
	          -o ............... 編集結果を標準出力に出力する
	USAGE
    exit 1
}

exit_trap() {
    set -- ${1:-} $?  # $? is set as $1 if no argument given
    trap '' EXIT HUP INT QUIT PIPE ALRM TERM
    [ -d "${Tmp:-}" ] && rm -rf "${Tmp%/*}/_${Tmp##*/_}"
    trap -  EXIT HUP INT QUIT PIPE ALRM TERM
    exit $1
}

error_exit() {
    ${2+:} false && echo "${0##*/}: $2" 1>&2
    exit $1
}

print_and_exec () {
    PS4=$( (set -x; :) 2>&1 | sed 's/:$//')
    echo "${PS4}${*}" 1>&2
    "${@}"
}


######################################################################
# Argument Parsing
######################################################################

while :; do
    case "${1:-}" in
        -e)        case $# in 1) error_exit 1 'Invalid -e option';; esac
                   ext=$2
                   shift 2
                   ;;
        -f)        case $# in 1) error_exit 1 'Invalid -f option';; esac
                   fname=$2
                   shift 2
                   ;;
        -o)        output=$1
                   shift
                   ;;
        --help|-h) print_usage_and_exit
                   ;;
        ?*)        error_exit 1 'Invalid option'
                   ;;
    esac
    if [ $# -eq 0 ]; then break; fi
done


######################################################################
# Main
######################################################################

trap 'exit_trap' EXIT HUP INT QUIT PIPE ALRM TERM
Tmp=$(mktemp -d -t "_${0##*/}.$$.XXXXXXXXXXX") || error_exit 1 'Failed to mktemp'

if ! [ -z ${fname+_} ]; then
    target_file="${Tmp}/${fname}"
else
    target_file="${Tmp}/tmp_${0##*/}"
fi
if ! [ -z ${ext+_} ]; then
    target_file="${target_file}.${ext}"
fi
cat > "${target_file}"

print_and_exec "${EDITOR}" "${target_file}" </dev/tty 1>&2

if ! [ -z ${output+_} ]; then
    cat "${target_file}"
fi
